<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAR-SAE v3.0 | Smart Settlement Bridge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Hind+Siliguri:wght@400;700&display=swap');
        
        body { 
            font-family: 'Space Grotesk', 'Hind Siliguri', sans-serif; 
            background-color: #020617; 
            color: #94a3b8; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        .glass { 
            background: rgba(15, 23, 42, 0.7); 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(255,255,255,0.05); 
        }

        .bridge-card {
            background: linear-gradient(135deg, #1e293b 0%, #020617 100%);
            border: 1px solid rgba(59, 130, 246, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .glow-text {
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        .log-container {
            height: 140px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            background: rgba(0,0,0,0.5);
            border-radius: 1rem;
            scrollbar-width: thin;
            scrollbar-color: #334155 transparent;
        }

        @keyframes pulse-border {
            0% { border-color: rgba(59, 130, 246, 0.1); box-shadow: 0 0 0px rgba(59, 130, 246, 0); }
            50% { border-color: rgba(59, 130, 246, 0.5); box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
            100% { border-color: rgba(59, 130, 246, 0.1); box-shadow: 0 0 0px rgba(59, 130, 246, 0); }
        }

        .active-bridge {
            animation: pulse-border 2s infinite;
        }

        .log-container::-webkit-scrollbar { width: 4px; }
        .log-container::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .tab-btn.active {
            background: rgba(59, 130, 246, 0.2);
            color: white;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .custom-msg-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2563eb;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="customMsg" class="custom-msg-box"></div>

    <div class="w-full max-w-lg">
        <header class="flex justify-between items-center mb-6 bg-slate-900/40 p-4 rounded-3xl border border-white/5">
            <div class="flex items-center gap-3">
                <div class="p-2.5 bg-blue-600 rounded-xl shadow-lg shadow-blue-500/20">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                </div>
                <div>
                    <h1 class="text-sm font-black text-white tracking-widest uppercase italic">DAR-SAE <span class="text-blue-500">v3.0</span></h1>
                    <p class="text-[8px] font-bold text-slate-500 uppercase tracking-[0.2em]">Quantum Node Bridge</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-[8px] font-bold text-slate-600 uppercase">UID</p>
                <p id="userIdDisplay" class="text-[9px] font-mono text-blue-400 italic">Connecting...</p>
            </div>
        </header>

        <div class="flex gap-2 mb-6 bg-slate-900/40 p-1.5 rounded-2xl border border-white/5">
            <button id="dashboardTab" onclick="switchTab('dashboard')" class="tab-btn active flex-1 py-2.5 rounded-xl text-[10px] font-bold uppercase tracking-widest transition-all">ড্যাশবোর্ড</button>
            <button id="referralTab" onclick="switchTab('referral')" class="tab-btn flex-1 py-2.5 rounded-xl text-[10px] font-bold uppercase tracking-widest transition-all">রেফারেল</button>
        </div>

        <div id="dashboardSection" class="block">
            <div id="mainBridgeCard" class="bridge-card rounded-[2.5rem] p-8 mb-6 relative overflow-hidden transition-all duration-500">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">Secure Node Assets</h2>
                    <div class="flex items-center gap-1.5">
                        <span id="statusDot" class="w-2 h-2 bg-red-500 rounded-full"></span>
                        <span id="statusLabel" class="text-[9px] font-bold text-slate-500 uppercase">অফলাইন</span>
                    </div>
                </div>

                <div class="text-center mb-10">
                    <p class="text-xs text-slate-500 font-medium mb-1 uppercase tracking-widest italic">সংগৃহীত মোট আয়</p>
                    <div class="flex items-center justify-center gap-2">
                        <span class="text-2xl font-bold text-blue-500/40">৳</span>
                        <h2 id="balanceDisplay" class="text-6xl font-black text-white glow-text tracking-tighter">0.00</h2>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-8">
                    <div class="glass p-4 rounded-2xl border-l-2 border-blue-500">
                        <p class="text-[8px] font-bold text-slate-500 uppercase mb-1">সিস্টেম রিজার্ভ (৭০%)</p>
                        <p id="masterShare" class="text-sm font-bold text-white tracking-tight">৳0.00</p>
                    </div>
                    <div class="glass p-4 rounded-2xl border-l-2 border-emerald-500">
                        <p class="text-[8px] font-bold text-slate-500 uppercase mb-1">উইথড্রযোগ্য (৩০%)</p>
                        <p id="userShare" class="text-sm font-bold text-emerald-400 tracking-tight">৳0.00</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="showMessage('Withdraw Locked: গেটওয়ে মেইনটেইন্যান্সে আছে।')" class="flex-1 bg-white/5 border border-white/10 py-3.5 rounded-xl text-[9px] font-bold uppercase tracking-widest text-white hover:bg-white/10 transition-all active:scale-95">উইথড্র</button>
                    <button id="mainBtn" onclick="toggleEngine()" class="flex-1 bg-blue-600 text-white py-3.5 rounded-xl text-[10px] font-bold uppercase tracking-widest shadow-lg active:scale-95 transition-all">কানেক্ট</button>
                </div>
            </div>

            <div id="controlPanel" class="glass rounded-[2rem] p-6 mb-6">
                <h3 class="text-[10px] font-bold text-white uppercase mb-3 tracking-widest">Live Node Logs</h3>
                <div id="logConsole" class="log-container p-4 text-slate-400">
                    <span class="text-blue-500">[SYSTEM]</span> সিস্টেম লোড হচ্ছে...
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-10">
                <div class="glass p-5 rounded-3xl text-center">
                    <p class="text-[8px] text-slate-500 font-bold uppercase mb-1 tracking-widest">ব্যান্ডউইথ ব্যবহার</p>
                    <p id="networkSpeed" class="text-lg font-black text-white italic tracking-tighter">0.00 KB/s</p>
                </div>
                <div class="glass p-5 rounded-3xl text-center">
                    <p class="text-[8px] text-slate-500 font-bold uppercase mb-1 tracking-widest">অ্যাক্টিভ গেটওয়ে</p>
                    <p class="text-lg font-black text-emerald-500 italic tracking-tighter">NODE-G7</p>
                </div>
            </div>
        </div>

        <div id="referralSection" class="hidden">
            <div class="bridge-card rounded-[2.5rem] p-8 mb-6 relative overflow-hidden">
                <div class="absolute -bottom-24 -left-24 w-64 h-64 bg-emerald-600/5 rounded-full blur-3xl"></div>
                <h2 class="text-center text-xl font-bold text-white mb-6 italic">Invite & Earn 5% Bonus</h2>
                
                <div class="bg-black/30 p-4 rounded-2xl mb-6 border border-white/5">
                    <p class="text-[9px] font-bold text-slate-500 uppercase mb-2 tracking-widest">আপনার রেফারেল লিংক</p>
                    <div class="flex items-center gap-2">
                        <input id="refLinkInput" readonly type="text" value="Generating..." class="flex-1 bg-transparent border-none text-[10px] font-mono text-blue-400 outline-none">
                        <button onclick="copyRefLink()" class="p-2 bg-blue-600 rounded-lg active:scale-90 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="glass p-4 rounded-2xl text-center">
                        <p class="text-[8px] font-bold text-slate-500 uppercase mb-1">মোট রেফারেল</p>
                        <p id="totalRefs" class="text-xl font-black text-white italic">0</p>
                    </div>
                    <div class="glass p-4 rounded-2xl text-center">
                        <p class="text-[8px] font-bold text-slate-500 uppercase mb-1">রেফারেল বোনাস</p>
                        <p id="refBonus" class="text-xl font-black text-emerald-500 italic">৳0.00</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ENVIRONMENT CONFIGURATION
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'dar-sae-v3-main';

        let isActive = false;
        let incomeInterval = null;
        let logs = [];

        function addLog(msg, type = 'info') {
            const consoleBox = document.getElementById('logConsole');
            const time = new Date().toLocaleTimeString([], { hour12: false });
            let color = 'text-slate-400';
            if(type === 'success') color = 'text-emerald-400';
            if(type === 'error') color = 'text-red-400';
            if(type === 'warning') color = 'text-yellow-500';

            logs.push(`<span class="text-slate-600 font-bold">[${time}]</span> <span class="${color}">${msg}</span>`);
            if (logs.length > 15) logs.shift();
            consoleBox.innerHTML = logs.join('<br>');
            consoleBox.scrollTop = consoleBox.scrollHeight;
        }

        window.switchTab = (tab) => {
            const dashSect = document.getElementById('dashboardSection');
            const refSect = document.getElementById('referralSection');
            const dashTab = document.getElementById('dashboardTab');
            const refTab = document.getElementById('referralTab');

            if(tab === 'dashboard') {
                dashSect.style.display = 'block';
                refSect.style.display = 'none';
                dashTab.classList.add('active');
                refTab.classList.remove('active');
            } else {
                dashSect.style.display = 'none';
                refSect.style.display = 'block';
                dashTab.classList.remove('active');
                refTab.classList.add('active');
            }
        };

        const initEngine = async () => {
            addLog("ইঞ্জিন ভেরিফিকেশন শুরু হচ্ছে...");
            try {
                // Rule 3: Auth First
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        document.getElementById('userIdDisplay').innerText = user.uid.substring(0, 10) + "...";
                        const currentUrl = window.location.href.split('?')[0];
                        document.getElementById('refLinkInput').value = `${currentUrl}?ref=${user.uid}`;
                        const urlParams = new URLSearchParams(window.location.search);
                        const refBy = urlParams.get('ref');
                        setupDataSync(user.uid, refBy);
                    }
                });
            } catch (err) { addLog("কানেকশন এরর!", 'error'); }
        };

        async function setupDataSync(uid, refBy) {
            if (!auth.currentUser) return;
            // Rule 1: Strict Paths
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
            
            try {
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists()) {
                    await setDoc(userRef, {
                        balance: 0,
                        refBonus: 0,
                        invitedBy: (refBy && refBy !== uid) ? refBy : null,
                        refCount: 0,
                        createdAt: Date.now()
                    });
                    if(refBy && refBy !== uid) {
                        const inviterRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', refBy);
                        await updateDoc(inviterRef, { refCount: increment(1) }).catch(()=>{});
                    }
                }

                onSnapshot(userRef, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        const bal = data.balance || 0;
                        document.getElementById('balanceDisplay').innerText = bal.toFixed(2);
                        document.getElementById('masterShare').innerText = "৳" + (bal * 0.70).toFixed(2);
                        document.getElementById('userShare').innerText = "৳" + (bal * 0.30).toFixed(2);
                        document.getElementById('totalRefs').innerText = data.refCount || 0;
                        document.getElementById('refBonus').innerText = "৳" + (data.refBonus || 0).toFixed(2);
                    }
                }, (error) => {
                    console.error("Permission issue:", error);
                    addLog("ডাটা সিঙ্ক এরর! পাথ চেক করুন।", "error");
                });
            } catch (e) { console.error(e); }
        }

        window.toggleEngine = () => {
            isActive = !isActive;
            const btn = document.getElementById('mainBtn');
            const card = document.getElementById('mainBridgeCard');
            const dot = document.getElementById('statusDot');
            const lbl = document.getElementById('statusLabel');

            if (isActive) {
                btn.innerText = "স্টপ ইঞ্জিন";
                btn.classList.replace('bg-blue-600', 'bg-red-900/40');
                card.classList.add('active-bridge');
                dot.classList.replace('bg-red-500', 'bg-emerald-500');
                lbl.innerText = "অনলাইন";
                addLog("নোড কানেকশন সফল। মাইনিং শুরু হয়েছে।", 'success');

                incomeInterval = setInterval(async () => {
                    if(!isActive || !auth.currentUser) return;
                    
                    const gain = Math.random() * 0.005;
                    const user = auth.currentUser;
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                    
                    try {
                        await updateDoc(userRef, { balance: increment(gain) });
                        
                        const snap = await getDoc(userRef);
                        const inviterId = snap.data()?.invitedBy;
                        if(inviterId) {
                            const bonus = gain * 0.05;
                            const inviterRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', inviterId);
                            await updateDoc(inviterRef, {
                                balance: increment(bonus),
                                refBonus: increment(bonus)
                            }).catch(()=>{});
                        }
                    } catch (e) { console.error(e); }
                    
                    document.getElementById('networkSpeed').innerText = (Math.random()*50 + 10).toFixed(2) + " KB/s";
                }, 3000);
            } else {
                if (incomeInterval) clearInterval(incomeInterval);
                btn.innerText = "কানেক্ট";
                btn.classList.replace('bg-red-900/40', 'bg-blue-600');
                card.classList.remove('active-bridge');
                dot.classList.replace('bg-emerald-500', 'bg-red-500');
                lbl.innerText = "অফলাইন";
                document.getElementById('networkSpeed').innerText = "0.00 KB/s";
                addLog("সিস্টেম বন্ধ করা হয়েছে।", 'warning');
            }
        };

        window.copyRefLink = () => {
            const input = document.getElementById("refLinkInput");
            input.select();
            input.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                showMessage("রেফারেল লিংক কপি হয়েছে!");
                addLog("রেফারেল লিংক ক্লিপবোর্ডে কপি করা হয়েছে।", 'success');
            } catch (err) {
                showMessage("কপি করা সম্ভব হয়নি!");
            }
        };

        window.showMessage = (msg) => {
            const el = document.getElementById('customMsg');
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        };

        window.onload = initEngine;
    </script>
</body>
                    </html>
